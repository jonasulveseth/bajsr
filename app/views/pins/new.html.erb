<% content_for :full_screen_map, true %>

<div class="relative min-h-screen bg-slate-900">
  <%= form_with model: @pin, local: true, class: "h-full" do |form| %>
    <% if @pin.errors.any? %>
      <div class="absolute top-24 left-1/2 z-30 w-full max-w-md -translate-x-1/2 px-4">
        <div class="bg-red-500/20 border border-red-500/40 backdrop-blur-md rounded-2xl p-4 text-red-200 shadow-lg">
          <h2 class="text-red-100 font-semibold mb-2"><%= pluralize(@pin.errors.count, "error") %> needs attention:</h2>
          <ul class="text-sm space-y-1">
            <% @pin.errors.full_messages.each do |message| %>
              <li>• <%= message %></li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>

    <div 
      data-controller="map"
      data-map-center-value="<%= { lat: 59.3293, lng: 18.0686 }.to_json %>"
      data-map-zoom-value="10"
      data-map-pins-value="<%= j(@pins_payload.to_json) %>"
      class="absolute inset-0"
    >
      <div class="pointer-events-none absolute top-6 right-6 z-30 flex flex-col gap-2 text-white">
        <label for="group-selector" class="pointer-events-auto text-xs uppercase tracking-wide text-white/70">Grupp</label>
        <select id="group-selector" class="pointer-events-auto bg-slate-900/95 border border-white/20 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500" onchange="if(this.value){window.location.href='<%= new_pin_path %>?group_id=' + this.value}">
          <% @groups.each do |group| %>
            <option value="<%= group.id %>" <%= "selected" if group == @current_group %>><%= group.name %></option>
          <% end %>
        </select>
      </div>
      <div data-map-target="map" class="h-full w-full"></div>
      <%= form.hidden_field :latitude, step: :any, data: { map_target: "latitude" }, id: "pin_latitude" %>
      <%= form.hidden_field :longitude, step: :any, data: { map_target: "longitude" }, id: "pin_longitude" %>
      <%= form.hidden_field :group_id, value: @current_group.id %>

      <div data-map-target="panel" class="pointer-events-none hidden absolute inset-x-0 bottom-6 flex justify-center px-4">
        <div class="pointer-events-auto w-full max-w-2xl rounded-3xl border border-white/20 bg-slate-900/95 text-white shadow-2xl backdrop-blur-xl">
          <div class="flex flex-col gap-6 p-6 md:p-8">
            <header class="space-y-2">
              <h1 class="text-3xl font-bold">Add your report</h1>
              <p class="text-sm text-white/70">Placera markören på kartan. Fyll sedan i detaljerna nedan och dela din observation med communityn.</p>
            </header>

            <div class="grid md:grid-cols-2 gap-6">
              <div class="space-y-4">
                <div>
                  <%= form.label :rating, class: "block text-sm font-medium text-white/80 mb-2 uppercase tracking-wide" %>
                  <div class="flex space-x-2">
                    <% 5.times do |i| %>
                      <button type="button" 
                              data-rating="<%= i + 1 %>"
                              class="rating-star w-12 h-12 rounded-xl border border-white/20 bg-white/5 text-white hover:bg-yellow-400 hover:text-yellow-900 transition-colors"
                              onclick="setRating(<%= i + 1 %>)">
                        <svg class="w-6 h-6 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                      </button>
                    <% end %>
                  </div>
                  <%= form.hidden_field :rating, id: "pin_rating" %>
                </div>

                <div>
                  <%= form.label :image, class: "block text-sm font-medium text-white/80 mb-2 uppercase tracking-wide" %>
                  <div class="border-2 border-dashed border-white/20 rounded-xl p-6 text-center hover:border-green-400/50 transition-colors">
                    <%= form.file_field :image, 
                        accept: "image/*",
                        class: "hidden",
                        id: "pin_image_input" %>
                    <label for="pin_image_input" class="cursor-pointer">
                      <svg class="w-12 h-12 text-white/50 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                      <p class="text-white/80">Ladda upp en bild (valfritt)</p>
                      <p class="text-white/50 text-xs">PNG eller JPG upp till 5 MB</p>
                    </label>
                  </div>
                  <div id="image_preview" class="mt-2 hidden">
                    <img id="preview_img" class="w-full h-32 object-cover rounded-lg" />
                  </div>
                </div>
              </div>

              <div class="space-y-4">
                <div>
                  <%= form.label :comment, class: "block text-sm font-medium text-white/80 mb-2 uppercase tracking-wide" %>
                  <%= form.text_area :comment, 
                      rows: 6,
                      placeholder: "Berätta vad du har hittat, och hur platsen ser ut...",
                      class: "w-full px-4 py-3 bg-white/5 border border-white/20 rounded-xl text-white placeholder-white/40 focus:border-green-400 focus:outline-none transition-colors resize-none" %>
                </div>

                <div class="flex flex-wrap gap-3">
                  <%= form.submit "Spara pin", class: "inline-flex items-center justify-center rounded-xl bg-green-600 px-6 py-3 text-sm font-semibold text-white transition-colors hover:bg-green-500", onclick: "console.log('Button clicked!'); return validateForm()", id: "submit-button" %>
                  <%= link_to "Avbryt", pins_path, class: "inline-flex items-center justify-center rounded-xl bg-white/10 px-6 py-3 text-sm font-semibold text-white/80 transition-colors hover:bg-white/20" %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<script>
function setRating(rating) {
  document.getElementById('pin_rating').value = rating;
  
  // Update star display
  document.querySelectorAll('.rating-star').forEach((star, index) => {
    if (index < rating) {
      star.classList.add('bg-yellow-400', 'text-yellow-900');
      star.classList.remove('bg-white/10', 'text-white');
    } else {
      star.classList.remove('bg-yellow-400', 'text-yellow-900');
      star.classList.add('bg-white/10', 'text-white');
    }
  });
}

function validateForm() {
  console.log('validateForm called');
  const latitude = document.getElementById('pin_latitude').value;
  const longitude = document.getElementById('pin_longitude').value;
  const rating = document.getElementById('pin_rating').value;
  const comment = document.querySelector('textarea[name="pin[comment]"]').value;
  
  console.log('Form data:', { latitude, longitude, rating, comment });
  
  if (!latitude || !longitude) {
    alert('Klicka på kartan för att placera en markör först.');
    return false;
  }
  
  if (!rating) {
    alert('Välj ett betyg genom att klicka på stjärnorna.');
    return false;
  }
  
  if (!comment.trim()) {
    alert('Skriv en kommentar om vad du hittade.');
    return false;
  }
  
  console.log('Form validation passed!');
  return true;
}

// Image preview
document.getElementById('pin_image_input').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('preview_img').src = e.target.result;
      document.getElementById('image_preview').classList.remove('hidden');
    }
    reader.readAsDataURL(file);
  }
});

</script>
